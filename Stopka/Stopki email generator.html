<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generator stopki Medidesk</title>
  <link href="https://fonts.googleapis.com/css?family=EuclidCircularB:400,700&display=swap&subset=latin-ext" rel="stylesheet">
  <style>
    @font-face {
      font-family: "EuclidCircularB";
      font-style: normal;
      font-weight: 300;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Light.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: italic;
      font-weight: 300;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-LightItalic.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: normal;
      font-weight: 400;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Regular.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: italic;
      font-weight: 400;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Italic.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: normal;
      font-weight: 500;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Medium.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: italic;
      font-weight: 500;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-MediumItalic.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: normal;
      font-weight: 600;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-SemiBold.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: italic;
      font-weight: 600;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-SemiBoldItalic.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: normal;
      font-weight: 700;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Bold.woff") format("woff");
    }
    @font-face {
      font-family: "EuclidCircularB";
      font-style: italic;
      font-weight: 700;
      src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-BoldItalic.woff") format("woff");
    }
  </style>
  <style>
    :root {
      color-scheme: light;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      --border-color: #d0d7de;
      --primary: #00bfa5;
      --primary-dark: #0097a7;
      --primary-gradient: linear-gradient(135deg, #00e5cc 0%, #00bfa5 50%, #0097a7 100%);
      --gray: #6c6f72;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: #f5f7fb;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    h1 {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .logo {
      width: 48px;
      height: 48px;
    }
    .wrapper {
      display: flex;
      gap: 2rem;
      max-width: 1400px;
      width: 100%;
      flex-direction: column; /* zawsze 1 kolumna */
    }
    form, .preview, .image-tool {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      flex: 1;
    }
    form#signatureForm {
      max-width: 700px;
      margin: 0 auto;
    }
    label {
      display: block;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    label:not(.photo-size):not([for]) {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: var(--primary-dark);
    }
    label.photo-size, label[for] {
      color: var(--primary-dark);
    }
    input, select, textarea {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
      transition: border-color 0.2s;
      color: #2c3e50 !important;
      background: #ffffff !important;
      font-family: inherit;
      -webkit-text-fill-color: #2c3e50 !important;
      caret-color: #00bfa5;
    }
    input:focus, textarea:focus {
      font-style: normal !important;
    }
    input::placeholder, textarea::placeholder {
      color: #b0bbc5 !important;
      opacity: 1 !important;
    }
    input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {
      color: #b0bbc5 !important;
      opacity: 1 !important;
    }
    input::-moz-placeholder, textarea::-moz-placeholder {
      color: #b0bbc5 !important;
      opacity: 1 !important;
    }
    input:-ms-input-placeholder, textarea:-ms-input-placeholder {
      color: #b0bbc5 !important;
      opacity: 1 !important;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    input[type="file"] {
      padding: 0.5rem;
      border: 2px solid var(--primary);
      background: linear-gradient(135deg, #e0f7f4 0%, #f0fffe 100%);
      cursor: pointer;
      font-weight: 500;
      color: var(--primary-dark);
    }
    input[type="file"]::file-selector-button {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary-dark);
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.75rem;
    }
    input[type="file"]::file-selector-button:hover {
      opacity: 0.9;
    }
    button {
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    button.primary {
      background: var(--primary-gradient);
      color: white;
      border: none;
    }
    button.primary:hover {
      opacity: 1;
      filter: brightness(1.1);
    }
    button.secondary {
      background: #e0e0e0;
      color: #333;
    }
    button.action-btn {
      border: 2px solid var(--primary);
      background: linear-gradient(135deg, #ffffff 0%, #f0fdfb 100%);
      box-shadow: 0 2px 8px rgba(0, 191, 165, 0.15);
      font-weight: 600;
    }
    button.action-btn:hover:not(:disabled) {
      box-shadow: 0 4px 12px rgba(0, 191, 165, 0.25);
      transform: translateY(-1px);
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    textarea#output {
      height: 420px;
      width: 100%;
      box-sizing: border-box;
      font-family: "Cascadia Code", "Fira Code", Consolas, monospace;
      font-size: 0.85rem;
      line-height: 1.45;
      resize: none;
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 12px;
      border: 2px solid var(--border-color);
    }
    .hint {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 4px;
    }
    .info-box {
      border: 1px dashed var(--border-color);
      border-radius: 10px;
      padding: 12px;
      background: #f8fafc;
    }
    .hidden-input {
      display: none;
    }
    .row {
      display: flex;
      gap: 1rem;
    }
    .row label {
      flex: 1;
    }
    .tool-title {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-top: 0;
    }
    .canvas-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 1rem auto;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      background: #f0f0f0;
    }
    #photoCanvas {
      display: block;
      width: 100%;
      height: 100%;
      cursor: move;
    }
    .zoom-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .zoom-controls button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      align-items: center;
    }
    .photo-size {
      flex: 1;
    }
    .field-hint {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }

    /* --- Mobile-friendly accordion (custom cards) --- */
    .step-card {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: #fff;
      margin-bottom: 0.75rem;
      overflow: hidden;
    }
    .step-header {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      background: #f8fafc;
      transition: background 0.2s;
    }
    .step-header:hover {
      background: #f1f5f9;
    }
    .step-header::after {
      content: "‚ñæ";
      color: var(--gray);
      font-weight: 700;
      flex-shrink: 0;
      transition: transform 0.2s;
    }
    .step-card.is-open .step-header::after {
      content: "‚ñ¥";
    }
    .step-content {
      padding: 1rem;
      display: none;
      border-top: 1px solid var(--border-color);
    }
    .step-card.is-open .step-content {
      display: block;
    }
    
    /* Tooltip styles */
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ffffff;
      color: var(--primary-dark);
      border: 2px solid var(--primary);
      font-size: 12px;
      font-weight: bold;
      font-style: italic;
      cursor: help;
      margin-left: 0.5rem;
      position: relative;
    }
    .tooltip-icon::after {
      content: attr(data-tooltip);
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--primary-dark);
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
      padding: 1rem 1.25rem;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 500;
      font-style: normal;
      line-height: 1.6;
      white-space: normal;
      width: 340px;
      max-width: 85vw;
      text-align: left;
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
      z-index: 9999;
      pointer-events: none;
    }
    .tooltip-icon:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* Karty trybu zdjƒôcia */
    .photo-mode-card {
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .photo-mode-card:hover {
      box-shadow: 0 4px 12px rgba(0, 191, 165, 0.2);
      transform: translateY(-1px);
    }

    /* Ma≈Çe literowe etykiety na przyciskach (sekcja zdjƒôcia) */
    .key-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--primary) !important;
      color: #ffffff !important;
      font-size: 11px;
      font-weight: 700;
      margin-right: 6px;
    }
    .key-badge.white-bg {
      background: #ffffff;
      color: var(--primary-dark);
      border: 2px solid var(--primary);
    }

    /* Modal niskiej rozdzielczo≈õci */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
    }
    .modal-overlay.is-open {
      display: flex;
    }
    .modal-card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.18);
      max-width: 520px;
      width: 100%;
      padding: 1.25rem 1.5rem;
      color: #0f172a;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .modal-card h3 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
      color: var(--primary-dark);
    }
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .modal-actions button {
      min-width: 120px;
    }
    .modal-actions .secondary {
      background: #e2e8f0;
      color: #0f172a;
    }
    
    @media (max-width: 980px) {
      .actions {
        flex-direction: column;
      }
      textarea#output {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <h1>
    <img src="https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/20251001%20MD%20fav.png" alt="Medidesk" class="logo" />
    Generator stopki Medidesk
  </h1>
  <div class="wrapper">
    <form id="signatureForm">
      <!-- Krok 1: Zdjƒôcie -->
      <section class="step-card image-tool is-open" id="step1-photo" data-step="1">
        <div class="step-header">Krok 1 (opcjonalnie): Zdjƒôcie do stopki</div>
        <div class="step-content">
          <p class="hint">Przesu≈Ñ i powiƒôksz zdjƒôcie, aby dopasowaƒá do okrƒôgu. Pobierz i wklej rƒôcznie w programie pocztowym.</p>
          <label>
            Wgraj zdjƒôcie (JPG/PNG)
          </label>
          <div style="margin-top: 0.5rem;">
            <button type="button" class="secondary action-btn" id="triggerFileInput" style="position: relative;">
              <span class="key-badge">A</span>
              Wybierz plik
            </button>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" />
            <span id="fileNameDisplay" class="hint" style="margin-left: 0.75rem;">Nie wybrano pliku</span>
          </div>
          <div class="canvas-wrapper">
            <canvas id="photoCanvas"></canvas>
          </div>
          <div class="zoom-controls">
            <button type="button" id="zoomOut" title="Pomniejsz">‚àí</button>
            <span>ZOOM</span>
            <button type="button" id="zoomIn" title="Powiƒôksz">+</button>
          </div>
          <div class="image-actions">
            <label class="photo-size">
              Rozmiar PNG
              <select id="photoSize">
                <option value="109">109√ó109 (rozmiar w email)</option>
                <option value="218" selected>218√ó218 (2x - zalecane)</option>
                <option value="327">327√ó327 (3x - wysoka jako≈õƒá)</option>
              </select>
            </label>
            <button type="button" class="secondary" id="resetPhoto" disabled>Wyczy≈õƒá</button>
            <button type="button" class="primary" id="downloadPhoto" disabled>Pobierz zdjƒôcie</button>
          </div>
          <div class="image-actions" style="margin-top: 0.5rem;">
            <button type="button" class="secondary action-btn" id="confirmPhotoCrop" disabled><span class="key-badge">B</span>Zatwierd≈∫ kadr</button>
            <div id="photoCropStatus" class="hint" style="margin: 0;">Status kadru: brak zdjƒôcia</div>
          </div>
          <!-- Wyb√≥r trybu zdjƒôcia -->
          <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;" id="photoModeSelector">
            <!-- Opcja 1: Manualna -->
            <div class="photo-mode-card" id="modeManual" style="padding: 0.75rem; background: #fafafa; border-radius: 8px; border: 2px solid #e5e7eb; cursor: pointer; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);">
              <label style="display: flex; align-items: flex-start; gap: 0.5rem; font-weight: normal !important; cursor: pointer; background: none !important; -webkit-text-fill-color: #333 !important; color: #333 !important; margin: 0;">
                <input type="radio" name="photoMode" value="manual" id="photoModeManual" style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                <span style="color: #333 !important; background: none !important; -webkit-text-fill-color: #333 !important; font-size: 0.9rem; line-height: 1.4;">
                  <strong><span class="key-badge">C</span>üì• Tryb rƒôczny</strong><br>
                  <span style="font-size: 0.85rem; color: #666 !important; -webkit-text-fill-color: #666 !important;">
                    Pobierz zdjƒôcie przyciskiem ‚ÄûPobierz zdjƒôcie" i wklej rƒôcznie do podpisu w programie pocztowym. T≈Ço poza ko≈Çem bƒôdzie przezroczyste.
                  </span>
                </span>
              </label>
            </div>
            <!-- Opcja 2: Automatyczna -->
            <div class="photo-mode-card" id="modeAuto" style="padding: 0.75rem; background: #fafafa; border-radius: 8px; border: 2px solid #e5e7eb; cursor: pointer; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);">
              <label style="display: flex; align-items: flex-start; gap: 0.5rem; font-weight: normal !important; cursor: pointer; background: none !important; -webkit-text-fill-color: #333 !important; color: #333 !important; margin: 0;">
                <input type="radio" name="photoMode" value="auto" id="photoModeAuto" disabled style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                <span style="color: #333 !important; background: none !important; -webkit-text-fill-color: #333 !important; font-size: 0.9rem; line-height: 1.4;">
                  <strong><span class="key-badge">C</span>üöÄ Tryb automatyczny</strong>
                  <span class="tooltip-icon" data-tooltip="Aby zdjƒôcie mog≈Ço wy≈õwietlaƒá siƒô w stopce e-mail u wszystkich odbiorc√≥w, musi byƒá dostƒôpne pod publicznym adresem URL. Publikujemy je jako plik graficzny pod unikalnym, anonimowym linkiem; nie jest indeksowane ani u≈ºywane w innym kontek≈õcie.">i</span>
                  <br>
                  <span style="font-size: 0.85rem; color: #666 !important; -webkit-text-fill-color: #666 !important;">
                    Zdjƒôcie zostanie automatycznie wgrane na serwer i osadzone w stopce. HTML gotowy do wklejenia.
                  </span>
                  <span id="autoModeStatus" style="font-size: 0.8rem; color: #d32f2f !important; -webkit-text-fill-color: #d32f2f !important; display: block; margin-top: 0.25rem;">
                    ‚ö†Ô∏è Najpierw zatwierd≈∫ kadr zdjƒôcia.
                  </span>
                  <!-- Zgoda (widoczna tylko gdy tryb auto wybrany i kadr zatwierdzony) -->
                  <div id="autoConsentBox" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                    <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer; margin: 0;">
                      <input type="checkbox" id="uploadPhotoConsent" style="width: 18px; height: 18px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
                      <span style="font-size: 0.8rem; color: #333 !important; -webkit-text-fill-color: #333 !important; line-height: 1.4;">
                        Wyra≈ºam zgodƒô na przetwarzanie mojego wizerunku w postaci zdjƒôcia profilowego wykorzystywanego wy≈ÇƒÖcznie w firmowej stopce e-mail. O≈õwiadczam, ≈ºe posiadam prawa do wykorzystania przekazanego zdjƒôcia. Zgoda jest dobrowolna i mo≈ºe zostaƒá cofniƒôta.
                      </span>
                    </label>
                  </div>
                </span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- Krok 2: Dane -->
      <section class="step-card" id="step2-data" data-step="2">
        <div class="step-header">Krok 2: Dane osobowe</div>
        <div class="step-content">
          <label>
            Forma po≈ºegnania
            <select id="greeting" required>
              <option value="Serdecznie pozdrawiam">Serdecznie pozdrawiam</option>
              <option value="Pozdrawiam">Pozdrawiam</option>
              <option value="Pozdrawiam serdecznie">Pozdrawiam serdecznie</option>
              <option value="__custom__">W≈Çasna tre≈õƒá‚Ä¶</option>
            </select>
          </label>
          <label id="customGreetingWrapper" class="hidden-input">
            W≈Çasne po≈ºegnanie
            <input id="customGreeting" placeholder="np. Z wyrazami szacunku" />
            <div class="hint">Generator doda przecinek po tej frazie automatycznie.</div>
          </label>
          <label>
            Imiƒô i nazwisko <span style="color: #d32f2f;">*</span>
            <input id="fullName" placeholder="przedstaw siƒô" style="font-style: italic;" required />
          </label>
          <label>
            Stanowisko
            <input id="role" placeholder="Business Development Manager/PreSales/Inne" style="font-style: italic;" />
          </label>
          <label>
            Telefon
            <input id="phone" placeholder="+48 ..." style="font-style: italic;" />
          </label>
          <label>
            E-mail <span style="color: #d32f2f;">*</span>
            <input id="email" placeholder="imiƒô.nazwisko@medidesk.com" style="font-style: italic;" required />
          </label>
          <label>
            LinkedIn (opcjonalnie)
            <input id="linkedin" placeholder="https://www.linkedin.com/in/..." style="font-style: italic;" />
          </label>
          <label style="margin-bottom: 0.5rem;">
            Link pod adresem
          </label>
          <div style="display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal !important; cursor: pointer; background: none !important; -webkit-text-fill-color: #333 !important; color: #333 !important;">
              <input type="checkbox" id="linkMedidesk" value="medidesk" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="color: #333 !important; background: none !important; -webkit-text-fill-color: #333 !important;">medidesk.com</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal !important; cursor: pointer; background: none !important; -webkit-text-fill-color: #333 !important; color: #333 !important;">
              <input type="checkbox" id="linkEdu" value="edu" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="color: #333 !important; background: none !important; -webkit-text-fill-color: #333 !important;">medidesk.edu.pl</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Krok 3: Banner -->
      <section class="step-card" id="step3-banner" data-step="3">
        <div class="step-header">Krok 3: Wybierz banner w stopce email</div>
        <div class="step-content">
          <div class="hint" style="margin-top: 0.5rem; margin-bottom: 0.75rem;">Kliknij wybrany banner</div>
          <div id="bannerGallery" style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
            <span style="color: var(--gray); font-size: 0.85rem; text-align: center;">≈Åadowanie dostƒôpnych banner√≥w...</span>
          </div>
        </div>
      </section>

      <!-- Krok 4: Wyb√≥r wersji -->
      <section class="step-card" id="step4-version" data-step="4">
        <div class="step-header">Krok 4: Wybierz wersjƒô stopki (BASIC / FULL)</div>
        <div class="step-content">
          <div style="display:flex; flex-direction:column; gap:0.5rem;">
            <label style="display:flex; align-items:flex-start; gap:0.5rem; font-weight: normal !important; cursor:pointer; background: none !important; -webkit-text-fill-color:#333 !important; color:#333 !important; margin:0;">
              <input type="radio" name="signatureVariant" id="sigVariantBasic" value="BASIC" checked style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
              <span style="font-size:0.92rem; line-height:1.4;">
                <strong>BASIC</strong><br>
                <span style="font-size:0.85rem; color:#666 !important; -webkit-text-fill-color:#666 !important;">
                  ‚ÄûForward‚Äësafe‚Äù ‚Äî prosta struktura, tekst zamiast drobnych ikonek.
                </span>
                <ul style="margin: 0.45rem 0 0 1.1rem; padding: 0; color: #334155; font-size: 0.85rem; line-height: 1.45;">
                  <li>wiƒôksza odporno≈õƒá na forward (mniej element√≥w do ‚Äûzgubienia‚Äù)</li>
                  <li>mniejsza szansa na rozsypanie odstƒôp√≥w i wyr√≥wna≈Ñ</li>
                  <li>bez ma≈Çych ikonek (zastƒÖpione tekstem)</li>
                </ul>
                <div style="margin-top: 0.5rem;">
                  <img
                    src="https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/BASIC.png"
                    alt="PodglƒÖd wersji BASIC"
                    style="display:block; width: 100%; max-width: 520px; height: auto; border: 1px solid var(--border-color); border-radius: 10px; background:#fff;"
                    loading="lazy"
                  />
                </div>
              </span>
            </label>

            <label style="display:flex; align-items:flex-start; gap:0.5rem; font-weight: normal !important; cursor:pointer; background: none !important; -webkit-text-fill-color:#333 !important; color:#333 !important; margin:0;">
              <input type="radio" name="signatureVariant" id="sigVariantFull" value="FULL" style="width: 20px; height: 20px; cursor: pointer; margin-top: 2px; flex-shrink: 0;">
              <span style="font-size:0.92rem; line-height:1.4;">
                <strong>FULL</strong><br>
                <span style="font-size:0.85rem; color:#666 !important; -webkit-text-fill-color:#666 !important;">
                  Pe≈Çny wyglƒÖd (fonty + ikonki). Najlepsze do podpisu ustawianego ‚Äûna sta≈Çe‚Äù, niekoniecznie do forward√≥w.
                </span>
                <ul style="margin: 0.45rem 0 0 1.1rem; padding: 0; color: #334155; font-size: 0.85rem; line-height: 1.45;">
                  <li>pe≈Çne fonty + ikonki (naj≈Çadniejszy wariant)</li>
                  <li>przy forwardowaniu klient poczty mo≈ºe zignorowaƒá style / podmieniƒá font</li>
                  <li>mogƒÖ siƒô zmieniƒá odstƒôpy, ≈Çamanie linii lub zniknƒÖƒá ma≈Çe ikonki</li>
                </ul>
                <div style="margin-top: 0.5rem;">
                  <img
                    src="https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/FULL.png"
                    alt="PodglƒÖd wersji FULL"
                    style="display:block; width: 100%; max-width: 520px; height: auto; border: 1px solid var(--border-color); border-radius: 10px; background:#fff;"
                    loading="lazy"
                  />
                </div>
                <div style="margin-top: 0.35rem; color:#64748b; font-size: 0.85rem; font-style: italic;">
                  W ka≈ºdej chwili mo≈ºesz zmieniƒá wersjƒô i kliknƒÖƒá ‚ÄûGeneruj stopkƒô HTML‚Äù ponownie.
                </div>
              </span>
            </label>
          </div>
        </div>
      </section>

      <!-- Krok 5: Generuj -->
      <section class="step-card" id="step5-generate" data-step="5">
        <div class="step-header">Krok 5: Wygeneruj i skopiuj HTML</div>
        <div class="step-content">
          <div id="photoSummary" class="info-box" style="margin-bottom: 1rem; padding: 0.75rem; font-size: 0.9rem;">
            <strong>üì∑ Zdjƒôcie:</strong> <span id="photoSummaryText">Nie wgrano zdjƒôcia ‚Äî w stopce pojawi siƒô placeholder [WSTAW_ZDJECIE].</span>
          </div>
          <div class="actions">
            <button type="submit" class="primary">Generuj stopkƒô HTML</button>
            <button type="button" id="copyBtn" class="secondary" disabled>Kopiuj HTML do schowka</button>
          </div>
          
          <!-- Instrukcja wklejania (widoczna po wygenerowaniu) -->
          <div id="pasteInstruction" style="display: none; margin-top: 1rem;">
            <div style="padding: 0.75rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 0.5rem;">
              <strong style="color: #1565c0;">üìß Outlook / Gmail / Apple Mail</strong>
              <p style="margin: 0.5rem 0 0; font-size: 0.85rem; line-height: 1.5;">
                Skopiuj stopkƒô <strong>z podglƒÖdu</strong> (zaznacz stopkƒô w sekcji ‚ÄûPodglƒÖd stopki‚Äù ‚Üí Ctrl+C), a nastƒôpnie wklej do edytora podpisu (Ctrl+V).
              </p>
            </div>
            <div style="padding: 0.75rem; background: #fce4ec; border-radius: 8px; border-left: 4px solid #e91e63;">
              <strong style="color: #c2185b;">üîß Zoho CRM</strong>
              <p style="margin: 0.5rem 0 0; font-size: 0.85rem; line-height: 1.5;">
                Kliknij ‚ÄûKopiuj HTML do schowka‚Äù, przejd≈∫ do edytora podpisu i wklej jako <strong>HTML (kod ≈∫r√≥d≈Çowy)</strong> ‚Äì opcja ‚ÄûWklej jako HTML‚Äù lub &lt;/&gt;.
              </p>
            </div>
          </div>
          
          <textarea id="output" readonly style="display: none;"></textarea>
        </div>
      </section>

      <!-- PodglƒÖd stopki -->
      <section class="step-card" id="panelPreview">
        <div class="step-header">Krok 6: PodglƒÖd stopki</div>
        <div class="step-content">
          <div id="preview" style="border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; background: #fafafa; min-height: 200px; overflow: auto;">
            <p style="color: #999; text-align: center;">Uzupe≈Çnij formularz i kliknij "Generuj stopkƒô HTML", aby zobaczyƒá podglƒÖd</p>
          </div>
        </div>
      </section>
    </form>

  </div>

  <!-- Modal: niska rozdzielczo≈õƒá zdjƒôcia -->
  <div class="modal-overlay" id="lowResModal">
    <div class="modal-card">
      <h3>Zdjƒôcie ma niskƒÖ rozdzielczo≈õƒá</h3>
      <p id="lowResText">Zdjƒôcie ma niskƒÖ rozdzielczo≈õƒá. Zalecamy min. 400√ó400 px dla lepszej jako≈õci. Czy chcesz kontynuowaƒá?</p>
      <div class="modal-actions">
        <button type="button" class="secondary" id="lowResCancel">Wybierz inne zdjƒôcie</button>
        <button type="button" class="primary" id="lowResOk">Kontynuuj mimo to</button>
      </div>
    </div>
  </div>

  <!-- Modal: instrukcja wklejania stopki -->
  <div class="modal-overlay" id="instructionModal">
    <div class="modal-card" style="max-width: 600px;">
      <h3>‚úÖ Stopka wygenerowana!</h3>
      <p style="margin: 0.75rem 0;">Teraz mo≈ºesz wkleiƒá stopkƒô do programu pocztowego:</p>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin: 1rem 0;">
        <div style="padding: 0.75rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
          <strong style="color: #1565c0;">üìß Outlook / Gmail / Apple Mail</strong>
          <p style="margin: 0.5rem 0 0; font-size: 0.9rem; line-height: 1.5;">
            Skopiuj stopkƒô <strong>z podglƒÖdu</strong> (zaznacz stopkƒô w sekcji ‚ÄûPodglƒÖd stopki‚Äù ‚Üí Ctrl+C), a nastƒôpnie wklej do edytora podpisu (Ctrl+V).
          </p>
        </div>
        
        <div style="padding: 0.75rem; background: #fce4ec; border-radius: 8px; border-left: 4px solid #e91e63;">
          <strong style="color: #c2185b;">üîß Zoho CRM</strong>
          <p style="margin: 0.5rem 0 0; font-size: 0.9rem; line-height: 1.5;">
            Kliknij ‚ÄûKopiuj HTML do schowka‚Äù, przejd≈∫ do edytora podpisu i wklej jako <strong>HTML (kod ≈∫r√≥d≈Çowy)</strong> ‚Äì opcja ‚ÄûWklej jako HTML‚Äù lub &lt;/&gt;.
          </p>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="primary" id="instructionOk">Rozumiem</button>
      </div>
    </div>
  </div>

  <script>
    // === KONFIGURACJA API ===
    const API_BASE_URL = "https://wfirma-api.onrender.com";
    const API_KEY = "5566a1c91b84e36ec055c6a8e5c5d04e";
    
    const outputEl = document.getElementById("output");
    const copyBtn = document.getElementById("copyBtn");
    const form = document.getElementById("signatureForm");
    const greetingSelect = document.getElementById("greeting");
    const customGreetingWrapper = document.getElementById("customGreetingWrapper");
    const customGreetingInput = document.getElementById("customGreeting");
    const bannerGallery = document.getElementById("bannerGallery");
    let selectedBannerUrl = "";
    let selectedBannerLink = ""; // Link docelowy dla wybranego bannera
    let uploadedPhotoUrl = ""; // URL wgranego zdjƒôcia z serwera
    let isPhotoCropConfirmed = false; // czy u≈ºytkownik zatwierdzi≈Ç kadr zdjƒôcia (wymagane dla publikacji)
    const LI_ICON_DATA = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/li_mini.png";
    const WEB_ICON_DATA = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/web_mini.png";
    const PHONE_ICON_DATA = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/phone_mini.png";
    const MAIL_ICON_DATA = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/mail_mini.png";
    
    // --- Zmienne canvasa (deklarowane wcze≈õnie dla dostƒôpu z funkcji) ---
    const photoInput = document.getElementById("photoInput");
    const triggerFileInput = document.getElementById("triggerFileInput");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const canvas = document.getElementById("photoCanvas");
    const ctx = canvas.getContext("2d");
    
    // Klikniƒôcie w custom przycisk otwiera dialog wyboru pliku
    if (triggerFileInput) {
      triggerFileInput.addEventListener("click", () => {
        photoInput?.click();
      });
    }
    const downloadPhotoBtn = document.getElementById("downloadPhoto");
    const resetPhotoBtn = document.getElementById("resetPhoto");
    const photoSizeSelect = document.getElementById("photoSize");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomOutBtn = document.getElementById("zoomOut");
    const confirmPhotoCropBtn = document.getElementById("confirmPhotoCrop");
    const photoCropStatusEl = document.getElementById("photoCropStatus");
    const uploadPhotoConsentEl = document.getElementById("uploadPhotoConsent");
    let img = null;
    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;

    // Modal niskiej rozdzielczo≈õci (zwraca Promise<boolean>)
    const showLowResModal = (width, height) => {
      return new Promise((resolve) => {
        const modal = document.getElementById("lowResModal");
        const textEl = document.getElementById("lowResText");
        const btnOk = document.getElementById("lowResOk");
        const btnCancel = document.getElementById("lowResCancel");
        if (!modal || !textEl || !btnOk || !btnCancel) {
          resolve(false);
          return;
        }
        textEl.textContent = `Zdjƒôcie ma niskƒÖ rozdzielczo≈õƒá (${width}√ó${height} px). Zalecamy min. 400√ó400 px dla lepszej jako≈õci. Czy chcesz kontynuowaƒá?`;
        modal.classList.add("is-open");

        const cleanup = () => {
          modal.classList.remove("is-open");
          btnOk.onclick = null;
          btnCancel.onclick = null;
        };

        btnOk.onclick = () => { cleanup(); resolve(true); };
        btnCancel.onclick = () => { cleanup(); resolve(false); };
      });
    };

    // Modal z instrukcjƒÖ wklejania stopki
    const showInstructionModal = () => {
      return new Promise((resolve) => {
        const modal = document.getElementById("instructionModal");
        const btnOk = document.getElementById("instructionOk");
        if (!modal || !btnOk) {
          resolve();
          return;
        }
        modal.classList.add("is-open");

        const cleanup = () => {
          modal.classList.remove("is-open");
          btnOk.onclick = null;
          
          // Poka≈º sta≈ÇƒÖ instrukcjƒô pod przyciskami
          const pasteInstruction = document.getElementById("pasteInstruction");
          if (pasteInstruction) pasteInstruction.style.display = "block";
        };

        btnOk.onclick = () => { cleanup(); resolve(); };
      });
    };
    
    // Funkcja uploadu zdjƒôcia na serwer
    const uploadPhotoToServer = async () => {
      if (!img) return null; // Brak zdjƒôcia
      if (!API_KEY) {
        console.warn("Brak API_KEY - zdjƒôcie nie zostanie wgrane na serwer");
        return null;
      }
      
      const size = parseInt(photoSizeSelect.value, 10) || 218;
      
      // Eksportuj canvas do base64
      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = exportCanvas.height = size;
      const exportCtx = exportCanvas.getContext("2d");
      
      const scaleFactor = size / canvas.width;
      exportCtx.save();
      exportCtx.translate(offsetX * scaleFactor, offsetY * scaleFactor);
      const scaledWidth = img.width * scale * scaleFactor;
      const scaledHeight = img.height * scale * scaleFactor;
      exportCtx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
      exportCtx.restore();
      
      // Maska ko≈Çowa
      exportCtx.globalCompositeOperation = 'destination-in';
      exportCtx.beginPath();
      exportCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      exportCtx.fill();
      
      const base64 = exportCanvas.toDataURL("image/png");
      
      try {
        console.log("%cüì§ STOPKA: Wysy≈Çam zdjƒôcie na serwer...", "color: #00bfa5; font-weight: bold;");
        console.log("   Endpoint:", `${API_BASE_URL}/api/stopka/upload-photo`);
        console.log("   Rozmiar zdjƒôcia:", size + "x" + size + "px");
        
        const response = await fetch(`${API_BASE_URL}/api/stopka/upload-photo`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
          },
          body: JSON.stringify({ image_base64: base64 })
        });
        
        const data = await response.json();
        
        if (data.success && data.url) {
          uploadedPhotoUrl = data.url;
          console.log("%c‚úÖ STOPKA: Zdjƒôcie wgrane pomy≈õlnie!", "color: #4caf50; font-weight: bold;");
          console.log("   URL:", data.url);
          console.log("   Nazwa pliku:", data.filename);
          
          return data.url;
        } else {
          console.error("%c‚ùå STOPKA: B≈ÇƒÖd uploadu", "color: #f44336; font-weight: bold;");
          console.error("   Odpowied≈∫ serwera:", data);
          return null;
        }
      } catch (error) {
        console.error("%c‚ùå STOPKA: B≈ÇƒÖd po≈ÇƒÖczenia z API", "color: #f44336; font-weight: bold;");
        console.error("   Szczeg√≥≈Çy:", error);
        return null;
      }
    };

    const toggleCustomGreeting = () => {
      if (greetingSelect.value === "__custom__") {
        customGreetingWrapper.classList.remove("hidden-input");
        customGreetingInput.required = true;
        customGreetingInput.focus();
      } else {
        customGreetingWrapper.classList.add("hidden-input");
        customGreetingInput.required = false;
        customGreetingInput.value = "";
      }
    };

    greetingSelect.addEventListener("change", toggleCustomGreeting);
    toggleCustomGreeting();

    // Banner gallery - check which banners exist and display them
    const loadBanners = async () => {
      const baseUrlPromo = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/banner_akcja_";
      const baseUrlClassic = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/banner_email_";
      const promoBanners = [];
      const classicBanners = [];
      
      // Pobierz konfiguracjƒô link√≥w z GitHuba
      let bannerConfig = {};
      try {
        const configUrl = "https://raw.githubusercontent.com/adminzohomedidesk/Stopka_email/main/banner_config.json";
        const configResponse = await fetch(configUrl);
        if (configResponse.ok) {
          bannerConfig = await configResponse.json();
          console.log("‚úÖ Konfiguracja banner√≥w za≈Çadowana:", bannerConfig);
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è Nie uda≈Ço siƒô pobraƒá banner_config.json, u≈ºywam domy≈õlnych link√≥w");
      }
      
      // Check promo banner (tylko 1)
      const urlPromo = `${baseUrlPromo}1.png`;
      try {
        const response = await fetch(urlPromo, { method: 'HEAD' });
        if (response.ok) {
          const bannerFileName = "banner_akcja_1.png";
          const link = bannerConfig[bannerFileName]?.link || "https://medidesk.pl";
          promoBanners.push({ url: urlPromo, number: 1, type: 'akcja', link: link });
        }
      } catch (e) {}
      
      // Check classic banner (tylko 1)
      const urlClassic = `${baseUrlClassic}1.png`;
      try {
        const response = await fetch(urlClassic, { method: 'HEAD' });
        if (response.ok) {
          const bannerFileName = "banner_email_1.png";
          const link = bannerConfig[bannerFileName]?.link || "https://medidesk.pl";
          classicBanners.push({ url: urlClassic, number: 1, type: 'email', link: link });
        }
      } catch (e) {}
      
      const allBanners = [...promoBanners, ...classicBanners];
      
      if (allBanners.length === 0) {
        bannerGallery.innerHTML = '<span style="color: #d32f2f; font-size: 0.85rem; grid-column: 1/-1; text-align: center;">‚ö†Ô∏è Brak dostƒôpnych banner√≥w w repozytorium.</span>';
        return;
      }
      
      // Display banners in sections
      bannerGallery.innerHTML = '';
      
      // Promo section
      if (promoBanners.length > 0) {
        const promoHeader = document.createElement('h3');
        promoHeader.textContent = 'Promowana akcja';
        promoHeader.style.cssText = 'grid-column: 1/-1; color: var(--primary-dark); font-size: 0.95rem; margin: 0.5rem 0 0.25rem; font-weight: 600;';
        bannerGallery.appendChild(promoHeader);
      }
      
      promoBanners.forEach((banner, index) => {
        bannerGallery.appendChild(createBannerCard(banner, index));
      });
      
      // Classic section
      if (classicBanners.length > 0) {
        const classicHeader = document.createElement('h3');
        classicHeader.textContent = 'Klasyczne';
        classicHeader.style.cssText = 'grid-column: 1/-1; color: var(--primary-dark); font-size: 0.95rem; margin: 0.75rem 0 0.25rem; font-weight: 600;';
        bannerGallery.appendChild(classicHeader);
      }
      
      classicBanners.forEach((banner, index) => {
        bannerGallery.appendChild(createBannerCard(banner, promoBanners.length + index));
      });
    };
    
    const createBannerCard = (banner, index) => {
        const card = document.createElement('div');
        card.style.cssText = 'border: 3px solid transparent; border-radius: 8px; overflow: hidden; transition: all 0.2s; position: relative;';
        card.className = 'banner-card';
        
        const radioWrapper = document.createElement('label');
        radioWrapper.style.cssText = 'cursor: pointer; display: flex; flex-direction: row; align-items: center; gap: 1rem; padding: 0.5rem;';
        
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'bannerChoice';
        radio.value = banner.url;
        radio.id = `banner_${banner.type}_${banner.number}`;
        radio.required = index === 0;
        radio.style.cssText = 'width: 20px; height: 20px; cursor: pointer; margin: 0; flex-shrink: 0;';
        
        const img = document.createElement('img');
        img.src = banner.url;
        img.alt = `Banner ${banner.type} ${banner.number}`;
        img.style.cssText = 'width: 100%; height: auto; display: block; flex: 1;';
        
        radioWrapper.appendChild(radio);
        radioWrapper.appendChild(img);
        card.appendChild(radioWrapper);
        
        radio.addEventListener('change', () => {
          // Remove selection from all cards
          document.querySelectorAll('.banner-card').forEach(c => {
            c.style.borderColor = 'transparent';
            c.style.boxShadow = 'none';
          });
          
          // Mark this card as selected
          if (radio.checked) {
            card.style.borderColor = '#00bfa5';
            card.style.boxShadow = '0 4px 12px rgba(0, 191, 165, 0.3)';
            selectedBannerUrl = banner.url;
            selectedBannerLink = banner.link || "https://medidesk.pl"; // Link z config lub domy≈õlny
          }
        });
        
        return card;
    };
    
    loadBanners();

    const generateSignature = (silent = false) => {
      const greetingValue = greetingSelect.value;
      let greeting = greetingValue === "__custom__" ? customGreetingInput.value.trim() : greetingValue;
      let fullName = document.getElementById("fullName").value.trim();
      let role = document.getElementById("role").value.trim();
      let phone = document.getElementById("phone").value.trim();
      let email = document.getElementById("email").value.trim();
      let linkedin = document.getElementById("linkedin").value.trim();
      const linkMedidesk = document.getElementById("linkMedidesk").checked;
      const linkEdu = document.getElementById("linkEdu").checked;
      const bannerUrl = selectedBannerUrl;
      const bannerLink = selectedBannerLink || "https://medidesk.pl"; // Link z konfiguracji lub domy≈õlny

      // Sanityzacja: usu≈Ñ potencjalnie niebezpieczne znaki
      const sanitize = (str) => {
        return str.replace(/[<>\"'&]/g, '').trim();
      };

      greeting = sanitize(greeting);
      fullName = sanitize(fullName);
      role = sanitize(role);

      // Walidacja d≈Çugo≈õci
      if (greeting.length > 100) {
        if (!silent) alert("Forma po≈ºegnania jest za d≈Çuga (max 100 znak√≥w).");
        return false;
      }
      if (fullName.length < 2 || fullName.length > 100) {
        if (!silent) alert("Imiƒô i nazwisko musi mieƒá od 2 do 100 znak√≥w).");
        return false;
      }
      if (role.length > 100) {
        if (!silent) alert("Stanowisko jest za d≈Çugie (max 100 znak√≥w).");
        return false;
      }

      // Walidacja i formatowanie telefonu
      if (phone) {
        // Usu≈Ñ spacje i wszystkie znaki poza cyframi i +
        let cleanPhone = phone.replace(/\s+/g, '').replace(/[^\d+]/g, '');
        
        // Usu≈Ñ +48 lub 48 z poczƒÖtku
        cleanPhone = cleanPhone.replace(/^\+48/, '').replace(/^48/, '');
        
        // Zostaw tylko cyfry
        cleanPhone = cleanPhone.replace(/\D/g, '');
        
        if (cleanPhone.length !== 9) {
          if (!silent) alert("Numer telefonu musi mieƒá dok≈Çadnie 9 cyfr (bez +48).");
          return false;
        }
        phone = `+48 ${cleanPhone.slice(0,3)} ${cleanPhone.slice(3,6)} ${cleanPhone.slice(6,9)}`;
      }

      // Walidacja emaila
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        if (!silent) alert("Podaj poprawny adres e-mail (z @ i domenƒÖ).");
        return false;
      }

      // LinkedIn (opcjonalnie) ‚Äî normalizuj i waliduj ≈Çagodnie (≈ºeby nie ucinaƒá pola przez brak https)
      if (linkedin) {
        // dopisz protok√≥≈Ç, je≈õli u≈ºytkownik wklei≈Ç np. "www.linkedin.com/..." lub "linkedin.com/..."
        if (!/^https?:\/\//i.test(linkedin)) {
          linkedin = `https://${linkedin.replace(/^\/+/, '')}`;
        }
        // zaakceptuj linkedin.com (z www lub bez)
        if (!/https?:\/\/(www\.)?linkedin\.com\//i.test(linkedin)) {
          if (!silent) alert("Podaj poprawny link do profilu LinkedIn (np. https://www.linkedin.com/in/...).");
          return false;
        }
      }

      if (!greeting || !fullName || !email || !bannerUrl) {
        if (!silent) alert("Uzupe≈Çnij wszystkie wymagane pola (oznaczone gwiazdkƒÖ) i wybierz banner.");
        return false;
      }

      // Generuj linki w sekcji "Obserwuj nas"
      let observeLinks = '';
      if (linkMedidesk && linkEdu) {
        observeLinks = '<a href="https://medidesk.pl/" title="medidesk.pl" style="text-decoration:none !important; color: #00cca3 !important; border: none">medidesk.com</a> <span style="color: #00cca3 !important">|</span> <a href="https://medidesk.edu.pl/" title="medidesk.edu.pl" style="text-decoration:none !important; color: #00cca3 !important; border: none">medidesk.edu.pl</a> <span style="color: #00cca3 !important">|</span> ';
      } else if (linkMedidesk) {
        observeLinks = '<a href="https://medidesk.pl/" title="medidesk.pl" style="text-decoration:none !important; color: #00cca3 !important; border: none">medidesk.com</a> <span style="color: #00cca3 !important">|</span> ';
      } else if (linkEdu) {
        observeLinks = '<a href="https://medidesk.edu.pl/" title="medidesk.edu.pl" style="text-decoration:none !important; color: #00cca3 !important; border: none">medidesk.edu.pl</a> <span style="color: #00cca3 !important">|</span> ';
      }

      const signatureHtmlBasic = `<!DOCTYPE html>
<html lang="pl-PL">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
</head>
<body style="margin:0; padding:0;">
    <div style="font-family: Arial, sans-serif; font-size: 12px; line-height: 18px; color: #333333;">
      <div style="margin: 0 0 6px 0;">${greeting},</div>
      <table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;">
        <tr>
          <td width="120" valign="top" style="width:120px; padding:0 10px 0 0; vertical-align: top;">
            <img src="${uploadedPhotoUrl || '[WSTAW_ZDJECIE]'}" alt="${fullName}" width="109" height="109" style="display:block; width:109px; height:109px; border:1px solid #0074d7; border-radius:50%; object-fit:cover;" />
          </td>
          <td width="440" valign="top" style="width:440px; vertical-align: top;">
            <div style="margin:0; padding:0; font-size:14px; font-weight:700; color:#0074d7;">${fullName}</div>
            ${role ? `<div style="margin:0; padding:0; font-size:14px; font-weight:500; color:#333333;">${role}</div>` : ''}
            <div style="height:3px; width:90px; background:#0074d7; margin:8px 0;"></div>
            ${phone ? `<div style="margin:0; padding:0;"><span style="color:#333333;">tel: </span><a href="tel:${phone.replace(/\s/g, '')}" style="text-decoration:none; color:#00cca3;">${phone}</a></div>` : ''}
            <div style="margin:0; padding:0;"><span style="color:#333333;">email: </span><a href="mailto:${email}" style="text-decoration:none; color:#00cca3;">${email}</a></div>
            ${linkedin ? `<div style="margin:0; padding:0;"><span style="color:#333333;">LI: </span><a href="${linkedin}" style="text-decoration:none; color:#00cca3; font-weight:400;">dodaj mnie na LinkedIn</a></div>` : ''}
          </td>
        </tr>
      </table>
      <div style="margin-top: 10px;">
        <div style="margin:0; padding:0;">
          Medidesk Sp. z o.o. <span style="color:#0074d7; font-weight:700;">|</span>
          ul. W. Niegolewskiego 17/2 <span style="color:#0074d7; font-weight:700;">|</span>
          01-570 Warszawa <span style="color:#0074d7; font-weight:700;">|</span>
          tel. <a href="tel:+48222500850" style="text-decoration:none; color:#333333;">22 250 08 50</a>
        </div>
        <div style="margin-top: 6px;">
          <a href="${bannerLink}" target="_blank" style="text-decoration:none;">
            <img src="${bannerUrl}" alt="Medidesk" width="565" style="display:block; width:565px; max-width:100%; height:auto; border:0; margin:0;" />
          </a>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div style="color:#333333; font-size:12px; font-weight:500;">
          Obserwuj nas: ${observeLinks}<a href="https://www.facebook.com/medideskpl/" style="text-decoration:none; color:#00cca3;">Facebook</a> <span style="color:#00cca3;">|</span> <a href="https://www.linkedin.com/company/18386183/" style="text-decoration:none; color:#00cca3;">Linkedin</a>
        </div>
        <div style="margin-top:8px; color:#8f8f8f; font-size:9px; line-height:14px; font-weight:700;">
          Medidesk Sp. z o. o. | NIP: 701-065-95-20 | KRS: 0000659580 | REGON: 366382110
        </div>
        <div style="margin-top:8px; color:#8f8f8f; font-size:9px; line-height:14px; font-weight:700;">
          Tre≈õƒá tej wiadomo≈õci zawiera informacje poufne, przeznaczone tylko dla adresata. Udostƒôpnianie, ujawnianie, powielanie, rozpowszechnianie bƒÖd≈∫ powo≈Çywanie siƒô na jakikolwiek jej fragment jest zabronione.<br>
          W razie przypadkowego otrzymania tej wiadomo≈õci, prosimy o powiadomienie o tym nadawcy oraz trwa≈Çe jej usuniƒôcie.
        </div>
        <div style="margin-top:8px; color:#8f8f8f; font-size:9px; line-height:14px; font-weight:700;">
          Administratorem Twoich danych osobowych pozyskanych w zwiƒÖzku z prowadzonƒÖ korespondencjƒÖ jest Medidesk Sp. z o.o. z siedzibƒÖ w Warszawie 01-570, ul. W≈Çadys≈Çawa Niegolewskiego 17/2. Twoje dane osobowe bƒôdƒÖ przetwarzane w zakresie niezbƒôdnym do prowadzenia korespondencji elektronicznej oraz w celach z niej wynikajƒÖcych. Dodatkowe informacje o zasadach przetwarzania i ochrony Twoich danych osobowych dostƒôpne sƒÖ w naszej <a href="https://medidesk.pl/polityka-prywatnosci/" style="text-decoration:underline; color:#8f8f8f;">Polityce Prywatno≈õci</a> zamieszczonej na stronie internetowej <a href="https://medidesk.pl" style="text-decoration:underline; color:#8f8f8f;">medidesk.pl</a>.
        </div>
        <div style="margin-top:8px; color:#8f8f8f; font-size:9px; line-height:14px; font-weight:700;">
          Administratorem Twoich danych osobowych w zwiƒÖzku z TwojƒÖ aktywno≈õciƒÖ na naszym profilu firmowym Facebook jest Medidesk Sp. z o.o. W celu zapoznania siƒô z obowiƒÖzkiem informacyjnym w zakresie przetwarzania Twoich danych osobowych przez Medidesk Sp. z o.o. i Facebook Inc. <a href="https://medidesk.pl/obowiazek-informacyjny-rodo-facebook/" style="text-decoration:underline; color:#8f8f8f;">kliknij tu</a>.
        </div>
      </div>
    </div>
</body>
</html>`.trim();

      const signatureHtmlFull = `<!DOCTYPE html>
<html lang="pl-PL">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<link href="https://fonts.googleapis.com/css?family=EuclidCircularB:400,700&display=swap&subset=latin-ext" rel="stylesheet">
</head>

<style type="text/css">

    @font-face {
        font-family: "EuclidCircularB";
        font-style: normal;
        font-weight: 300;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Light.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: italic;
        font-weight: 300;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-LightItalic.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: normal;
        font-weight: 400;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Regular.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: italic;
        font-weight: 400;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Italic.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: normal;
        font-weight: 500;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Medium.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: italic;
        font-weight: 500;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-MediumItalic.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: normal;
        font-weight: 600;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-SemiBold.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: italic;
        font-weight: 600;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-SemiBoldItalic.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: normal;
        font-weight: 700;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-Bold.woff") format("woff");
    }

    @font-face {
        font-family: "EuclidCircularB";
        font-style: italic;
        font-weight: 700;
        src: url("https://medidesk.pl/email-footer/fonts/EuclidCircularB-BoldItalic.woff") format("woff");
    }

    img {
        max-width: 100%;
    }
    body {
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: none;
    }
    table tr td {
        font-family: 'EuclidCircularB', Arial, sans-serif;
        box-sizing: border-box;
        font-size: 12px;
        line-height: 18px;
        color: #333333;
        font-weight: 700
    }
    .main{
        max-width: 1280px;
        background-color: transparent;
    }
    .rbcc {
        border:0;
        cellpadding:0;
        cellspacing:0;
    }
    a {
        text-decoration: none;
        color: #333333;
    }
    @media only screen and (max-width:620px){
        .main{
            width: 100% !important;
        }
        .col-left {
            width: 30% !important;
        }
        .col-right {
            width: 70% !important;
        }
    }
</style>

<body>
    <p style="margin: 0; padding: 0; font-family: 'EuclidCircularB', Arial, sans-serif; font-size: 12px; font-weight: 500; line-height: 18px">${greeting},</p>
    <table class="main rbcc" bgcolor="transparent" style="table-layout: fixed;">
        <tr class="rbcc">
            <td bgcolor="transparent">
                <table class="rbcc" width="100%">
                    <tr>
                        <td class="col-left" width="130px" align="left" style="width: 130px; display: inline-block;">
                            <img src="${uploadedPhotoUrl || '[WSTAW_ZDJECIE]'}" alt="${fullName}" style="border: 0 !important; max-width: 100% !important; height: 109px !important; width: 109px !important; border: 1px #0074d7 solid !important; -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50% !important; object-fit: cover;" />
            </td>
                        <td class="col-right" width="490px" align="left" style="color: #333333 !important; width: 490px; display: inline-block;">
                            <p style="margin: 0 0 2px 0 !important; padding: 0 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 14px !important; font-weight: 700 !important; line-height: 18px !important; color: #0074d7 !important;">${fullName}</p>
                            ${role ? `<p style="margin: 0 !important; padding: 0 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 14px !important; font-weight: 500 !important; line-height: 18px !important; color: #333333 !important;">${role}</p>` : ''}
                            <hr style="height: 3px !important; width: 90px !important; background: #0074d7 !important; border: 0px solid; margin: 8px 0 !important">
                            ${phone ? `<a href="tel:${phone.replace(/\s/g, '')}" title="${phone}" style="text-decoration:none !important; color: #333333 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border: none; line-height: 18px !important">
                                <img src="${PHONE_ICON_DATA}" alt="${phone}" style="border: 0 !important; max-width: 18px !important; height: auto !important; margin-right: 5px !important;">
                                <span style="color: #333333 !important;">${phone}</span>
                            </a><br>` : ''}
                            <a href="mailto:${email}" title="${email}" style="text-decoration:none !important; color: #333333 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border: none; line-height: 18px !important">
                                <img src="${MAIL_ICON_DATA}" alt="${email}" style="border: 0 !important; max-width: 18px !important; height: auto !important; margin-right: 5px !important;">
                                <span style="color: #333333 !important;">${email}</span>
                            </a><br>
${linkedin ? `<a href="${linkedin}" title="${linkedin}" style="text-decoration:none !important; color: #333333 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border: none; line-height: 18px !important">
                                <img src="${LI_ICON_DATA}" alt="dodaj mnie do LinkedIn" style="border: 0 !important; max-width: 18px !important; height: auto !important; margin-right: 5px !important;">
                                <span style="color: #333333 !important;">dodaj mnie na LinkedIn</span>
                            </a><br>` : ''}
            </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="rbcc">
            <td bgcolor="transparent">
                <table class="rbcc" width="100%">
                    <tr>
                        <td width="100%" align="left" style="color: #333333 !important">
                            <p style="margin: 0 !important; padding: 0 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; line-height: 18px !important; color: #333333 !important">
                                Medidesk Sp. z o.o.
                                <span style="color: #0074d7 !important; font-weight: 700 !important;">|</span>
                                ul. W. Niegolewskiego 17/2
                                <span style="color: #0074d7 !important; font-weight: 700 !important;">|</span>
                                01-570 Warszawa
                                <span style="color: #0074d7 !important; font-weight: 700 !important;">|</span>
                                tel. <a href="tel:+48222500850" title="22 250 08 50" style="text-decoration:none !important; color: #333333 !important; border: none">22 250 08 50</a>
                            </p>                            
                            <a href="${bannerLink}" target="_blank">
                                <img src="${bannerUrl}" alt="Medidesk" style="margin: 0; border: 0; max-width: 100%; width: 565px; max-height: 91px; height: auto;" />
                            </a>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="rbcc">
            <td bgcolor="transparent">
                <table class="rbcc" width="100%" style="max-width: 565px;">
                    <tr>
                        <td width="100%" align="left" style="color: #333333 !important; font-family: 'EuclidCircularB', Arial, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; line-height: 18px !important">
                            Obserwuj nas: ${observeLinks}<a href="https://www.facebook.com/medideskpl/" title="Facebook" style="text-decoration:none !important; color: #00cca3 !important; border: none">Facebook</a> <span style="color: #00cca3 !important">|</span> <a href="https://www.linkedin.com/company/18386183/" title="Linkedin" style="text-decoration:none !important; color: #00cca3 !important; border: none">Linkedin</a>
                        </td>
                    </tr>
                    <tr>
                        <td width="100%" align="left" style="color: #8f8f8f; font-size: 9px; line-height: 14px;">
                            <p style="margin: 8px 0 0; padding: 0; font-family: 'EuclidCircularB', Arial, sans-serif; font-size: 9px; font-weight: 700; line-height: 14px">
                Medidesk Sp. z o. o. | NIP: 701-065-95-20 | KRS: 0000659580 | REGON: 366382110
                            </p>
                            <p style="margin: 8px 0 0; padding: 0; font-family: 'EuclidCircularB', Arial, sans-serif; font-size: 9px; font-weight: 700; line-height: 14px">
                                Tre≈õƒá tej wiadomo≈õci zawiera informacje poufne, przeznaczone tylko dla adresata. Udostƒôpnianie, ujawnianie, powielanie, rozpowszechnianie bƒÖd≈∫ powo≈Çywanie siƒô na jakikolwiek jej fragment jest zabronione.<br>
                                W razie przypadkowego otrzymania tej wiadomo≈õci, prosimy o powiadomienie o tym nadawcy oraz trwa≈Çe jej usuniƒôcie.
                            </p>
                            <p style="margin: 8px 0 0; padding: 0; font-family: 'EuclidCircularB', Arial, sans-serif; font-size: 9px; font-weight: 700; line-height: 14px">
                                Administratorem Twoich danych osobowych pozyskanych w zwiƒÖzku z prowadzonƒÖ korespondencjƒÖ jest Medidesk Sp. z o.o. z siedzibƒÖ w Warszawie 01-570, ul. W≈Çadys≈Çawa Niegolewskiego 17/2. Twoje dane osobowe bƒôdƒÖ przetwarzane w zakresie niezbƒôdnym do prowadzenia korespondencji elektronicznej oraz w celach z niej wynikajƒÖcych. Dodatkowe informacje o zasadach przetwarzania i ochrony Twoich danych osobowych dostƒôpne sƒÖ w naszej <a href="https://medidesk.pl/polityka-prywatnosci/" title="Polityce Prywatno≈õci" style="text-decoration:underline !important; color: #8f8f8f; border: none">Polityce Prywatno≈õci</a> zamieszczonej na stronie internetowej <a href="https://medidesk.pl" title="medidesk.pl" style="text-decoration:underline !important; color: #8f8f8f; border: none">medidesk.pl</a>.
                            </p>
                            <p style="margin: 8px 0 0; padding: 0; font-family: 'EuclidCircularB', Arial, sans-serif; font-size: 9px; font-weight: 700; line-height: 14px">
                                Administratorem Twoich danych osobowych w zwiƒÖzku z TwojƒÖ aktywno≈õciƒÖ na naszym profilu firmowym Facebook jest Medidesk Sp. z o.o. W celu zapoznania siƒô z obowiƒÖzkiem informacyjnym w zakresie przetwarzania Twoich danych osobowych przez Medidesk Sp. z o.o. i Facebook Inc. <a href="https://medidesk.pl/obowiazek-informacyjny-rodo-facebook/" title="ObowiƒÖzek informacyjny RODO ‚Äì Facebook" style="text-decoration:underline !important; color: #8f8f8f; border: none;">kliknij tu</a>.
                            </p>
            </td>
          </tr>
      </table>
            </td>
        </tr>
    </table>
</body>
</html>`.trim();

      const signatureVariant = document.getElementById("sigVariantFull")?.checked ? "FULL" : "BASIC";
      const signatureHtml = signatureVariant === "FULL" ? signatureHtmlFull : signatureHtmlBasic;

      outputEl.value = signatureHtml;
      
      // Renderuj podglƒÖd - dok≈Çadnie ten sam HTML co finalny kod
      const previewEl = document.getElementById("preview");
      previewEl.innerHTML = signatureHtml;
      
      copyBtn.disabled = false;
      copyBtn.classList.remove("secondary");
      copyBtn.classList.add("primary");
      // Nie blokuj ponownego generowania ‚Äî u≈ºytkownik mo≈ºe generowaƒá wielokrotnie
      
      return true;
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      
      console.log("%cüöÄ STOPKA: Generowanie stopki...", "color: #2196f3; font-weight: bold; font-size: 14px;");
      
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      const photoModeAuto = document.getElementById("photoModeAuto");
      const isAutoMode = photoModeAuto && photoModeAuto.checked;
      const uploadConsent = document.getElementById("uploadPhotoConsent")?.checked;
      
      // Tryb automatyczny wymaga zatwierdzonego kadru i zgody
      if (img && isAutoMode && !isPhotoCropConfirmed) {
        alert("Zanim opublikujesz zdjƒôcie, ustaw kadr i kliknij 'Zatwierd≈∫ kadr' w Kroku 1.");
        return;
      }
      if (img && isAutoMode && !uploadConsent) {
        alert("Zaznacz zgodƒô na publikacjƒô zdjƒôcia w Kroku 1.");
        return;
      }

      // Je≈õli tryb auto + zgoda + API_KEY - uploaduj PRZED generowaniem
      if (img && isAutoMode && uploadConsent && API_KEY) {
        console.log("%cüì∑ STOPKA: Tryb automatyczny - rozpoczynam upload", "color: #ff9800; font-weight: bold;");
        submitBtn.textContent = "Wysy≈Çam zdjƒôcie...";
        submitBtn.disabled = true;
        
        const photoUrl = await uploadPhotoToServer();
        if (!photoUrl) {
          console.warn("%c‚ö†Ô∏è STOPKA: Upload nieudany - u≈ºywam placeholder [WSTAW_ZDJECIE]", "color: #ff9800;");
        }
        
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      } else if (img && !isAutoMode) {
        console.log("%cüì∑ STOPKA: Tryb rƒôczny - placeholder w stopce", "color: #9e9e9e;");
        console.log("   U≈ºyj 'Pobierz zdjƒôcie' i wklej rƒôcznie w programie pocztowym");
        uploadedPhotoUrl = ""; // Reset URL
      } else if (img && !API_KEY) {
        console.warn("%c‚ö†Ô∏è STOPKA: Zdjƒôcie wykryte, ale brak API_KEY - upload pominiƒôty", "color: #ff9800;");
      } else {
        console.log("%cüì∑ STOPKA: Brak zdjƒôcia - u≈ºywam placeholder", "color: #9e9e9e;");
      }
      
      // Generuj stopkƒô DOPIERO PO uploadzie (je≈õli by≈Ç)
      generateSignature();
      
      // Po klikniƒôciu "Generuj stopkƒô" rozwi≈Ñ podglƒÖd stopki
      const previewPanel = document.getElementById("panelPreview");
      if (previewPanel && !previewPanel.classList.contains("is-open")) {
        previewPanel.classList.add("is-open");
      }
      if (previewPanel) {
        previewPanel.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
      
      console.log("%c‚úÖ STOPKA: Stopka wygenerowana!", "color: #4caf50; font-weight: bold; font-size: 14px;");
      
      // Poka≈º modal z instrukcjami
      await showInstructionModal();
    });

    // Live preview - generuj przy ka≈ºdej zmianie
    const livePreview = () => {
      const fullName = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();
      if (fullName && email) {
        try {
          generateSignature(true); // silent mode - bez alert√≥w
        } catch (e) {
          // Ignoruj b≈Çƒôdy podczas wpisywania
        }
      }
    };

    form.querySelectorAll('input:not([type="file"]), select').forEach(input => {
      input.addEventListener('input', livePreview);
    });
    document.getElementById('bannerGallery').addEventListener('click', livePreview);

    // Resetuj przyciski gdy u≈ºytkownik zmienia dane
    const resetButtons = () => {
      if (outputEl.value) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const copyBtn = document.getElementById("copyBtn");
        const pasteInstruction = document.getElementById("pasteInstruction");
        
        submitBtn.disabled = false;
        submitBtn.classList.remove("secondary");
        submitBtn.classList.add("primary");
        copyBtn.disabled = true;
        copyBtn.classList.remove("primary");
        copyBtn.classList.add("secondary");
        
        // Ukryj instrukcjƒô (poka≈ºe siƒô znowu po regenerowaniu)
        if (pasteInstruction) pasteInstruction.style.display = "none";
      }
    };
    const formInputs = form.querySelectorAll('input:not([type="file"]):not([type="hidden"]), select');
    formInputs.forEach(input => {
      input.addEventListener('input', resetButtons);
    });
    // Nas≈Çuchuj te≈º zmian w galerii banner√≥w
    const bannerGalleryEl = document.getElementById('bannerGallery');
    if (bannerGalleryEl) {
      bannerGalleryEl.addEventListener('click', resetButtons);
    }

    copyBtn.addEventListener("click", async () => {
      const html = outputEl.value.trim();
      if (!html) return;
      try {
        await navigator.clipboard.writeText(html);
        copyBtn.textContent = "Skopiowano!";
        setTimeout(() => { copyBtn.textContent = "Kopiuj HTML do schowka"; }, 2000);
      } catch (error) {
        alert("Nie uda≈Ço siƒô skopiowaƒá kodu. Skopiuj rƒôcznie z pola tekstowego.");
      }
    });

    // Sekcje: na starcie otwarty tylko Krok 1; dalej u≈ºytkownik sam otwiera/zamyka (bez auto-zamykania innych)
    const setupStepCardAccordion = () => {
      const cards = Array.from(document.querySelectorAll('.step-card'));
      if (cards.length === 0) return;

      const keepOpenId = "step1-photo";
      cards.forEach((card) => {
        if (card.id !== keepOpenId) card.classList.remove('is-open');
      });
      const keepOpenCard = document.getElementById(keepOpenId);
      if (keepOpenCard) keepOpenCard.classList.add('is-open');

      cards.forEach((card) => {
        const header = card.querySelector('.step-header');
        if (!header) return;

        header.addEventListener('click', () => {
          card.classList.toggle('is-open');
        });
      });
    };
    setupStepCardAccordion();

    // Generuje dataURL ze zdjƒôcia na canvasie (do podglƒÖdu lokalnego)
    const getPhotoDataURLFromCanvas = () => {
      if (!img) return null;
      
      const size = parseInt(photoSizeSelect.value, 10) || 218;
      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = exportCanvas.height = size;
      const exportCtx = exportCanvas.getContext("2d");
      
      const scaleFactor = size / canvas.width;
      exportCtx.save();
      exportCtx.translate(offsetX * scaleFactor, offsetY * scaleFactor);
      const scaledWidth = img.width * scale * scaleFactor;
      const scaledHeight = img.height * scale * scaleFactor;
      exportCtx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
      exportCtx.restore();
      
      // Maska ko≈Çowa
      exportCtx.globalCompositeOperation = 'destination-in';
      exportCtx.beginPath();
      exportCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      exportCtx.fill();
      
      return exportCanvas.toDataURL("image/png");
    };

    const setCropStatus = (text, color) => {
      if (!photoCropStatusEl) return;
      photoCropStatusEl.textContent = text;
      if (color) {
        photoCropStatusEl.style.color = color;
      } else {
        photoCropStatusEl.style.color = "";
      }
    };

    // Aktualizuje podsumowanie zdjƒôcia w kroku 4
    const updatePhotoSummary = () => {
      const summaryEl = document.getElementById("photoSummaryText");
      const summaryBox = document.getElementById("photoSummary");
      if (!summaryEl || !summaryBox) return;

      const hasPhoto = !!img;
      const cropConfirmed = isPhotoCropConfirmed;
      const photoModeManual = document.getElementById("photoModeManual");
      const photoModeAuto = document.getElementById("photoModeAuto");
      const isManualMode = photoModeManual && photoModeManual.checked;
      const isAutoMode = photoModeAuto && photoModeAuto.checked;
      const consentGiven = uploadPhotoConsentEl && uploadPhotoConsentEl.checked;

      if (!hasPhoto) {
        summaryEl.innerHTML = 'Nie wgrano zdjƒôcia ‚Äî w stopce pojawi siƒô placeholder <code>[WSTAW_ZDJECIE]</code>.';
        summaryBox.style.background = "#f8fafc";
        summaryBox.style.borderColor = "var(--border-color)";
      } else if (!cropConfirmed) {
        summaryEl.innerHTML = 'Zdjƒôcie wgrane, ale <strong>kadr niezatwierdzony</strong>. Ustaw kadr i kliknij "Zatwierd≈∫ kadr" w Kroku 1.';
        summaryBox.style.background = "#fffbeb";
        summaryBox.style.borderColor = "#f59e0b";
      } else if (!isManualMode && !isAutoMode) {
        summaryEl.innerHTML = '‚ö†Ô∏è <strong>Wybierz tryb zdjƒôcia</strong> (rƒôczny lub automatyczny) w Kroku 1.';
        summaryBox.style.background = "#fef3c7";
        summaryBox.style.borderColor = "#f59e0b";
      } else if (isManualMode) {
        summaryEl.innerHTML = 'üì• <strong>Tryb rƒôczny:</strong> W stopce pojawi siƒô placeholder. Pobierz zdjƒôcie przyciskiem "Pobierz zdjƒôcie" i wklej rƒôcznie w programie pocztowym.';
        summaryBox.style.background = "#f0fdf4";
        summaryBox.style.borderColor = "#22c55e";
      } else if (isAutoMode && !consentGiven) {
        summaryEl.innerHTML = 'üöÄ <strong>Tryb automatyczny:</strong> Zaznacz zgodƒô w Kroku 1, aby zdjƒôcie zosta≈Ço wgrane na serwer.';
        summaryBox.style.background = "#fef3c7";
        summaryBox.style.borderColor = "#f59e0b";
      } else if (isAutoMode && consentGiven) {
        summaryEl.innerHTML = 'üöÄ ‚úÖ Zdjƒôcie zostanie <strong>automatycznie wgrane</strong> na serwer i osadzone w stopce. HTML gotowy do wklejenia!';
        summaryBox.style.background = "#dcfce7";
        summaryBox.style.borderColor = "#22c55e";
      }
    };

    const setCropUnconfirmed = (reason = "") => {
      isPhotoCropConfirmed = false;
      uploadedPhotoUrl = "";

      // Reset zgody
      if (uploadPhotoConsentEl) {
        uploadPhotoConsentEl.checked = false;
      }

      // Wy≈ÇƒÖcz tryb auto i odznacz wszystkie tryby
      const photoModeAuto = document.getElementById("photoModeAuto");
      const autoModeStatus = document.getElementById("autoModeStatus");
      const autoConsentBox = document.getElementById("autoConsentBox");
      const modeManualCard = document.getElementById("modeManual");
      const modeAutoCard = document.getElementById("modeAuto");
      const photoModeManual = document.getElementById("photoModeManual");

      if (photoModeAuto) photoModeAuto.disabled = true;
      if (autoModeStatus) {
        autoModeStatus.style.display = "block";
        autoModeStatus.textContent = img ? "‚ö†Ô∏è Najpierw zatwierd≈∫ kadr zdjƒôcia." : "‚ö†Ô∏è Najpierw wgraj zdjƒôcie.";
      }
      if (autoConsentBox) autoConsentBox.style.display = "none";
      
      // Odznacz wszystkie tryby
      if (photoModeManual) photoModeManual.checked = false;
      if (photoModeAuto) photoModeAuto.checked = false;
      if (modeManualCard) { modeManualCard.style.borderColor = "#e5e7eb"; modeManualCard.style.background = "#fafafa"; }
      if (modeAutoCard) { modeAutoCard.style.borderColor = "#e5e7eb"; modeAutoCard.style.background = "#fafafa"; }

      if (confirmPhotoCropBtn) {
        confirmPhotoCropBtn.disabled = !img;
      }

      if (!img) {
        setCropStatus("Status kadru: brak zdjƒôcia", "var(--gray)");
        updatePhotoSummary();
        return;
      }

      const suffix = reason ? ` (${reason})` : "";
      setCropStatus(`Status kadru: niezatwierdzony${suffix} ‚Äî kliknij "Zatwierd≈∫ kadr"`, "#d97706");
      updatePhotoSummary();
    };

    const setCropConfirmed = () => {
      if (!img) return;
      isPhotoCropConfirmed = true;

      if (confirmPhotoCropBtn) {
        confirmPhotoCropBtn.disabled = true;
      }

      // Odblokuj tryb auto
      const photoModeAuto = document.getElementById("photoModeAuto");
      const autoModeStatus = document.getElementById("autoModeStatus");
      if (photoModeAuto) photoModeAuto.disabled = false;
      if (autoModeStatus) autoModeStatus.style.display = "none";

      setCropStatus("Status kadru: zatwierdzony ‚úÖ ‚Äî wybierz tryb zdjƒôcia", "#15803d");
      updatePhotoSummary();
    };

    // Obs≈Çuga prze≈ÇƒÖczania tryb√≥w zdjƒôcia
    const setupPhotoModeSelector = () => {
      const modeManualCard = document.getElementById("modeManual");
      const modeAutoCard = document.getElementById("modeAuto");
      const photoModeManual = document.getElementById("photoModeManual");
      const photoModeAuto = document.getElementById("photoModeAuto");
      const autoConsentBox = document.getElementById("autoConsentBox");

      const updateModeUI = () => {
        const isManual = photoModeManual && photoModeManual.checked;
        const isAuto = photoModeAuto && photoModeAuto.checked;
        
        if (modeManualCard) {
          modeManualCard.style.borderColor = isManual ? "#22c55e" : "#e5e7eb";
          modeManualCard.style.background = isManual ? "#f0fdf4" : "#fafafa";
          modeManualCard.style.boxShadow = isManual ? "0 4px 12px rgba(34, 197, 94, 0.25)" : "0 2px 6px rgba(0, 0, 0, 0.08)";
        }
        if (modeAutoCard) {
          modeAutoCard.style.borderColor = isAuto ? "#22c55e" : "#e5e7eb";
          modeAutoCard.style.background = isAuto ? "#f0fdf4" : "#fafafa";
          modeAutoCard.style.boxShadow = isAuto ? "0 4px 12px rgba(34, 197, 94, 0.25)" : "0 2px 6px rgba(0, 0, 0, 0.08)";
        }
        if (autoConsentBox) {
          autoConsentBox.style.display = isAuto ? "block" : "none";
        }
        updatePhotoSummary();
      };

      if (photoModeManual) photoModeManual.addEventListener("change", updateModeUI);
      if (photoModeAuto) photoModeAuto.addEventListener("change", updateModeUI);
      
      // Klikniƒôcie w kartƒô te≈º prze≈ÇƒÖcza radio
      if (modeManualCard && photoModeManual) {
        modeManualCard.addEventListener("click", () => {
          if (!photoModeManual.disabled) { photoModeManual.checked = true; updateModeUI(); }
        });
      }
      if (modeAutoCard && photoModeAuto) {
        modeAutoCard.addEventListener("click", () => {
          if (!photoModeAuto.disabled) { photoModeAuto.checked = true; updateModeUI(); }
        });
      }
    };

    // Inicjalny stan UI
    setCropUnconfirmed();
    setupPhotoModeSelector();
    if (confirmPhotoCropBtn) {
      confirmPhotoCropBtn.addEventListener("click", setCropConfirmed);
    }
    // Aktualizuj podsumowanie przy zmianie checkboxa zgody
    if (uploadPhotoConsentEl) {
      uploadPhotoConsentEl.addEventListener("change", updatePhotoSummary);
    }

    const drawCircleMask = () => {
      const size = canvas.width;
      ctx.clearRect(0, 0, size, size);
      
      // Draw image
      if (img) {
        ctx.save();
        ctx.translate(offsetX, offsetY);
        const scaledWidth = img.width * scale;
        const scaledHeight = img.height * scale;
        ctx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
        ctx.restore();
      }

      // Apply circular mask
      ctx.globalCompositeOperation = 'destination-in';
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw circle guide
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 3;
      ctx.setLineDash([10, 5]);
      ctx.beginPath();
      ctx.arc(size / 2, size / 2, size / 2 - 2, 0, Math.PI * 2);
      ctx.stroke();
      ctx.setLineDash([]);
    };

    const resetPhoto = () => {
      img = null;
      scale = 1;
      offsetX = 0;
      offsetY = 0;
      photoInput.value = "";
      uploadedPhotoUrl = ""; // Reset URL zdjƒôcia
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      downloadPhotoBtn.disabled = true;
      resetPhotoBtn.disabled = true;
      
      // Reset nazwy pliku
      if (fileNameDisplay) fileNameDisplay.textContent = "Nie wybrano pliku";
      
      setCropUnconfirmed();
    };

    const downloadPhoto = () => {
      if (!img) {
        alert("Najpierw wgraj zdjƒôcie.");
        return;
      }
      const size = parseInt(photoSizeSelect.value, 10) || 109;
      
      // Create export canvas
      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = exportCanvas.height = size;
      const exportCtx = exportCanvas.getContext("2d");
      
      // Scale factors
      const scaleFactor = size / canvas.width;
      
      exportCtx.save();
      exportCtx.translate(offsetX * scaleFactor, offsetY * scaleFactor);
      const scaledWidth = img.width * scale * scaleFactor;
      const scaledHeight = img.height * scale * scaleFactor;
      exportCtx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
      exportCtx.restore();

      // Apply circular mask
      exportCtx.globalCompositeOperation = 'destination-in';
      exportCtx.beginPath();
      exportCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
      exportCtx.fill();

      exportCanvas.toBlob((blob) => {
        if (!blob) {
          alert("Nie uda≈Ço siƒô wyeksportowaƒá zdjƒôcia.");
          return;
        }
        const blobUrl = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = blobUrl;
        link.download = `medidesk-photo-${size}.png`;
        link.click();
        URL.revokeObjectURL(blobUrl);
      }, "image/png", 1);
    };

    photoInput.addEventListener("change", (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      if (fileNameDisplay) fileNameDisplay.textContent = file.name;
      if (!file.type.startsWith("image/")) {
        alert("Wybierz plik graficzny (JPG/PNG).");
        return;
      }
      
      // Check file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert("Plik jest za du≈ºy (max 10 MB). Wybierz mniejsze zdjƒôcie.");
        photoInput.value = "";
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        img = new Image();
        img.onload = async () => {
          // Check image dimensions
          if (img.width < 200 || img.height < 200) {
            alert("‚ö†Ô∏è Zdjƒôcie jest za ma≈Çe (min. 200√ó200 px). Wybierz zdjƒôcie o wy≈ºszej rozdzielczo≈õci, aby uzyskaƒá dobrƒÖ jako≈õƒá.");
            photoInput.value = "";
            img = null;
            return;
          }
          
          if (img.width < 400 || img.height < 400) {
            const proceed = await showLowResModal(img.width, img.height);
            if (!proceed) {
              photoInput.value = "";
              img = null;
              return;
            }
          }
          
          // Set canvas size (fallback to 300 if wrapper is hidden)
          const wrapper = canvas.parentElement;
          const wrapperWidth = wrapper.clientWidth || 300;
          const size = Math.min(wrapperWidth, 500);
          canvas.width = canvas.height = size || 300;
          
          // Center image
          scale = Math.max(size / img.width, size / img.height);
          offsetX = (size - img.width * scale) / 2;
          offsetY = (size - img.height * scale) / 2;
          
          drawCircleMask();
          downloadPhotoBtn.disabled = false;
          resetPhotoBtn.disabled = false;
          setCropUnconfirmed("nowe zdjƒôcie");
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener("mousedown", (e) => {
      if (!img) return;
      isDragging = true;
      const rect = canvas.getBoundingClientRect();
      dragStartX = e.clientX - rect.left - offsetX;
      dragStartY = e.clientY - rect.top - offsetY;
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!isDragging || !img) return;
      const rect = canvas.getBoundingClientRect();
      offsetX = e.clientX - rect.left - dragStartX;
      offsetY = e.clientY - rect.top - dragStartY;
      if (isPhotoCropConfirmed) setCropUnconfirmed("zmieniono kadr");
      drawCircleMask();
    });

    canvas.addEventListener("mouseup", () => {
      isDragging = false;
    });

    canvas.addEventListener("mouseleave", () => {
      isDragging = false;
    });

    zoomInBtn.addEventListener("click", () => {
      if (!img) return;
      scale *= 1.1;
      if (isPhotoCropConfirmed) setCropUnconfirmed("zmieniono kadr");
      drawCircleMask();
    });

    zoomOutBtn.addEventListener("click", () => {
      if (!img) return;
      scale *= 0.9;
      if (isPhotoCropConfirmed) setCropUnconfirmed("zmieniono kadr");
      drawCircleMask();
    });

    resetPhotoBtn.addEventListener("click", resetPhoto);
    downloadPhotoBtn.addEventListener("click", downloadPhoto);
  </script>
</body>
</html>
